<!doctype html>
<html lang="fr">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Demande de facture - Location</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
        body {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="min-h-full bg-gradient-to-br from-slate-50 to-blue-50 p-6"><!-- Logo fixe en haut √† gauche -->
  <div style="position: fixed; top: 20px; left: 20px; z-index: 1000;"><img src="logomci.png" alt="Logo MCI" style="width: 120px; height: 120px; display: block;" onerror="this.style.display='none'; this.alt='Logo non disponible';">
  </div>
  <main class="max-w-4xl mx-auto"><!-- Header -->
   <header class="bg-white rounded-lg shadow-lg p-8 mb-6">
    <h1 id="form-title" class="text-3xl font-bold text-slate-800 mb-4">Demande de facture de location</h1>
    <div class="bg-blue-50 border-l-4 border-blue-600 p-4 mb-6">
     <p class="text-sm text-slate-700 leading-relaxed">Dans le cadre de la pr√©paration de la signature du bail relatif √† votre prochaine location, il est imp√©ratif de compl√©ter avec exactitude l'int√©gralit√© du formulaire ci-dessous.</p>
    </div>
    <div class="bg-amber-50 border-l-4 border-amber-500 p-4">
     <p class="text-sm font-semibold text-slate-800 mb-2">‚ö†Ô∏è Informations importantes :</p>
     <ul class="text-sm text-slate-700 space-y-1 ml-4 list-disc">
      <li>Apr√®s soumission, vous recevrez la facture officielle et le RIB sign√© de <span id="company-name">MEILLEUR CONSEIL IMMO</span></li>
      <li>Ces documents doivent √™tre remis obligatoirement lors de la signature du bail</li>
      <li>Aucun autre RIB ne doit √™tre utilis√©</li>
      <li>Cette proc√©dure assure la s√©curit√© des transactions et pr√©vient toute tentative de fraude</li>
     </ul>
    </div>
   </header><!-- Form -->
   <div class="bg-white rounded-lg shadow-lg p-8">
    <form id="demande-form" class="space-y-6">
     <div class="grid grid-cols-1 md:grid-cols-2 gap-6"><!-- 1. Nom et pr√©nom du mandataire -->
      <div class="md:col-span-2"><label for="nom-mandataire" class="block text-sm font-semibold text-slate-700 mb-2"> 1. Nom et pr√©nom du mandataire * </label> <input type="text" id="nom-mandataire" required class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all" placeholder="Nom et pr√©nom complets">
      </div><!-- 2. Email mandataire -->
      <div class="md:col-span-2"><label for="email-mandataire" class="block text-sm font-semibold text-slate-700 mb-2"> 2. Adresse email du mandataire * </label> <input type="email" id="email-mandataire" required class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all" placeholder="email@exemple.com">
      </div><!-- 3. Date de signature du bail -->
      <div><label for="date-signature" class="block text-sm font-semibold text-slate-700 mb-2"> 3. Date de signature du bail * </label> <input type="date" id="date-signature" required class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all">
      </div><!-- 4. Honoraires charge bailleur TTC -->
      <div><label for="honoraires-bailleur-ttc" class="block text-sm font-semibold text-slate-700 mb-2"> 4. Honoraires charge bailleur TTC * </label> <input type="text" id="honoraires-bailleur-ttc" required class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all" placeholder="Ex: 500 ‚Ç¨">
      </div><!-- 5. Honoraires charge locataire TTC -->
      <div><label for="honoraires-locataire-ttc" class="block text-sm font-semibold text-slate-700 mb-2"> 5. Honoraires charge locataire TTC * </label> <input type="text" id="honoraires-locataire-ttc" required class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all" placeholder="Ex: 800 ‚Ç¨">
      </div><!-- 6. D√©signation et adresse du bien -->
      <div class="md:col-span-2"><label for="designation-bien" class="block text-sm font-semibold text-slate-700 mb-2"> 6. D√©signation et adresse du bien * </label> <textarea id="designation-bien" required rows="3" class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all" placeholder="Adresse compl√®te et description du bien"></textarea>
      </div><!-- 7. Num√©ro du mandat -->
      <div class="md:col-span-2"><label for="numero-mandat" class="block text-sm font-semibold text-slate-700 mb-2"> 7. Num√©ro du mandat * </label> <input type="text" id="numero-mandat" required class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all" placeholder="Ex: M-2024-001">
      </div><!-- 8. Nom et adresse des bailleurs -->
      <div class="md:col-span-2">
       <div class="flex justify-between items-center mb-3"><label class="block text-sm font-semibold text-slate-700"> 8. Nom et adresse des bailleurs * </label>
        <div class="flex gap-2"><button type="button" onclick="ajouterBailleur()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-all shadow-sm"> ‚ûï Ajouter </button> <button type="button" onclick="supprimerBailleur()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-all shadow-sm"> ‚ûñ Retirer </button>
        </div>
       </div>
       <div id="bailleurs-container"></div>
      </div><!-- 9. Nom et adresse des locataires -->
      <div class="md:col-span-2">
       <div class="flex justify-between items-center mb-3"><label class="block text-sm font-semibold text-slate-700"> 9. Nom et adresse des locataires * </label>
        <div class="flex gap-2"><button type="button" onclick="ajouterLocataire()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-all shadow-sm"> ‚ûï Ajouter </button> <button type="button" onclick="supprimerLocataire()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-all shadow-sm"> ‚ûñ Retirer </button>
        </div>
       </div>
       <div id="locataires-container"></div>
      </div>
     </div><!-- Submit Button -->
     <div class="pt-6 border-t border-slate-200">
      <div class="bg-slate-50 rounded-lg p-4 mb-4">
       <p class="text-sm text-slate-700 text-center">üìß √Ä transmettre par mail : <span id="email-label" class="font-semibold text-blue-600">admin@meilleurconseil-immo.com</span></p>
      </div><button type="button" id="print-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-lg transition-all shadow-lg hover:shadow-xl" onclick="printForm()"> üñ®Ô∏è G√©n√©rer le PDF / Imprimer </button>
      <div id="success-message" class="hidden mt-4 bg-green-50 border-l-4 border-green-500 p-4 rounded">
       <p class="text-green-800 font-semibold">‚úì Demande soumise avec succ√®s !</p>
       <p class="text-sm text-green-700 mt-1">Votre demande a √©t√© enregistr√©e. Vous recevrez les documents n√©cessaires par email.</p>
      </div>
      <div id="error-message" class="hidden mt-4 bg-red-50 border-l-4 border-red-500 p-4 rounded">
       <p class="text-red-800 font-semibold">‚ùå Erreur lors de la soumission</p>
       <p class="text-sm text-red-700 mt-1" id="error-text">Une erreur s'est produite. Veuillez r√©essayer.</p>
      </div>
     </div>
    </form>
   </div>
  </main>
  <script>
        const defaultConfig = {
            form_title: "Demande de facture de location",
            company_name: "MEILLEUR CONSEIL IMMO",
            email_label: "admin@meilleurconseil-immo.com",
            background_color: "#f8fafc",
            surface_color: "#ffffff",
            text_color: "#1e293b",
            primary_action_color: "#2563eb",
            secondary_action_color: "#64748b",
            font_family: "Segoe UI",
            font_size: 16
        };

        let config = { ...defaultConfig };
        let currentRecordCount = 0;
        let bailleurCount = 1;
        let locataireCount = 1;

        const dataHandler = {
            onDataChanged(data) {
                currentRecordCount = data.length;
            }
        };

        // Fonction pour cr√©er un formulaire de bailleur
        function creerFormulaireBailleur(index) {
            return `
                <div class="bailleur-item space-y-4 p-6 bg-gradient-to-br from-slate-50 to-blue-50 rounded-lg border-2 border-slate-200 shadow-sm mb-4" data-index="${index}">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-slate-700">Bailleur ${index}</h3>
                    </div>
                    <div>
                        <label for="bailleur-nom-${index}" class="block text-sm font-medium text-slate-700 mb-2">
                            üë§ Nom complet *
                        </label>
                        <input
                            type="text"
                            id="bailleur-nom-${index}"
                            required
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all bg-white shadow-sm"
                            placeholder="NOM Pr√©nom"
                        />
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label for="bailleur-numero-${index}" class="block text-sm font-medium text-slate-700 mb-2">
                                üè† N¬∞ *
                            </label>
                            <input
                                type="number"
                                id="bailleur-numero-${index}"
                                required
                                min="1"
                                class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all bg-white shadow-sm"
                                placeholder="123"
                            />
                        </div>
                        <div class="md:col-span-3">
                            <label for="bailleur-voie-${index}" class="block text-sm font-medium text-slate-700 mb-2">
                                ÔøΩÔøΩ Nom de la voie *
                            </label>
                            <input
                                type="text"
                                id="bailleur-voie-${index}"
                                required
                                class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all bg-white shadow-sm"
                                placeholder="Rue de la R√©publique"
                            />
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="bailleur-cp-${index}" class="block text-sm font-medium text-slate-700 mb-2">
                                üìÆ Code postal *
                            </label>
                            <input
                                type="text"
                                id="bailleur-cp-${index}"
                                required
                                pattern="[0-9]{5}"
                                maxlength="5"
                                class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all bg-white shadow-sm"
                                placeholder="75001"
                                oninput="loadCities('bailleur', ${index}, this.value)"
                            />
                        </div>
                        <div>
                            <label for="bailleur-ville-${index}" class="block text-sm font-medium text-slate-700 mb-2">
                                üèôÔ∏è Ville *
                            </label>
                            <select
                                id="bailleur-ville-${index}"
                                required
                                class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all bg-white shadow-sm cursor-pointer"
                            >
                                <option value="">Saisir d'abord le code postal</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
        }

        // Fonction pour cr√©er un formulaire de locataire
        function creerFormulaireLocataire(index) {
            return `
                <div class="locataire-item space-y-4 p-6 bg-gradient-to-br from-slate-50 to-blue-50 rounded-lg border-2 border-slate-200 shadow-sm mb-4" data-index="${index}">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-slate-700">Locataire ${index}</h3>
                    </div>
                    <div>
                        <label for="locataire-nom-${index}" class="block text-sm font-medium text-slate-700 mb-2">
                            üë§ Nom complet *
                        </label>
                        <input
                            type="text"
                            id="locataire-nom-${index}"
                            required
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all bg-white shadow-sm"
                            placeholder="NOM Pr√©nom"
                        />
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label for="locataire-numero-${index}" class="block text-sm font-medium text-slate-700 mb-2">
                                üè† N¬∞ *
                            </label>
                            <input
                                type="number"
                                id="locataire-numero-${index}"
                                required
                                min="1"
                                class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all bg-white shadow-sm"
                                placeholder="123"
                            />
                        </div>
                        <div class="md:col-span-3">
                            <label for="locataire-voie-${index}" class="block text-sm font-medium text-slate-700 mb-2">
                                üìç Nom de la voie *
                            </label>
                            <input
                                type="text"
                                id="locataire-voie-${index}"
                                required
                                class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all bg-white shadow-sm"
                                placeholder="Rue de la R√©publique"
                            />
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="locataire-cp-${index}" class="block text-sm font-medium text-slate-700 mb-2">
                                üìÆ Code postal *
                            </label>
                            <input
                                type="text"
                                id="locataire-cp-${index}"
                                required
                                pattern="[0-9]{5}"
                                maxlength="5"
                                class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all bg-white shadow-sm"
                                placeholder="75001"
                                oninput="loadCities('locataire', ${index}, this.value)"
                            />
                        </div>
                        <div>
                            <label for="locataire-ville-${index}" class="block text-sm font-medium text-slate-700 mb-2">
                                üèôÔ∏è Ville *
                            </label>
                            <select
                                id="locataire-ville-${index}"
                                required
                                class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all bg-white shadow-sm cursor-pointer"
                            >
                                <option value="">Saisir d'abord le code postal</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
        }

        // Initialiser les formulaires
        function initialiserFormulaires() {
            const bailleursContainer = document.getElementById('bailleurs-container');
            const locatairesContainer = document.getElementById('locataires-container');
            
            bailleursContainer.innerHTML = creerFormulaireBailleur(1);
            locatairesContainer.innerHTML = creerFormulaireLocataire(1);
        }

        // Ajouter un bailleur
        function ajouterBailleur() {
            bailleurCount++;
            const container = document.getElementById('bailleurs-container');
            const newBailleur = document.createElement('div');
            newBailleur.innerHTML = creerFormulaireBailleur(bailleurCount);
            container.appendChild(newBailleur.firstElementChild);
        }

        // Supprimer un bailleur
        function supprimerBailleur() {
            const container = document.getElementById('bailleurs-container');
            const items = container.querySelectorAll('.bailleur-item');
            
            if (items.length <= 1) {
                showError('Au moins un bailleur est requis.');
                return;
            }
            
            items[items.length - 1].remove();
            bailleurCount--;
        }

        // Ajouter un locataire
        function ajouterLocataire() {
            locataireCount++;
            const container = document.getElementById('locataires-container');
            const newLocataire = document.createElement('div');
            newLocataire.innerHTML = creerFormulaireLocataire(locataireCount);
            container.appendChild(newLocataire.firstElementChild);
        }

        // Supprimer un locataire
        function supprimerLocataire() {
            const container = document.getElementById('locataires-container');
            const items = container.querySelectorAll('.locataire-item');
            
            if (items.length <= 1) {
                showError('Au moins un locataire est requis.');
                return;
            }
            
            items[items.length - 1].remove();
            locataireCount--;
        }

        function showSuccess() {
            const successMsg = document.getElementById('success-message');
            const errorMsg = document.getElementById('error-message');
            errorMsg.classList.add('hidden');
            successMsg.classList.remove('hidden');
            setTimeout(() => {
                successMsg.classList.add('hidden');
            }, 5000);
        }

        function showError(message) {
            const successMsg = document.getElementById('success-message');
            const errorMsg = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            successMsg.classList.add('hidden');
            errorText.textContent = message;
            errorMsg.classList.remove('hidden');
            setTimeout(() => {
                errorMsg.classList.add('hidden');
            }, 5000);
        }

        // Fonction pour charger les villes depuis l'API du gouvernement fran√ßais
        async function loadCities(type, index, postalCode) {
            const selectElement = document.getElementById(`${type}-ville-${index}`);
            
            if (postalCode.length !== 5) {
                selectElement.innerHTML = '<option value="">Code postal invalide (5 chiffres requis)</option>';
                return;
            }
            
            selectElement.innerHTML = '<option value="">Chargement...</option>';
            
            try {
                const response = await fetch(`https://geo.api.gouv.fr/communes?codePostal=${postalCode}&fields=nom,code`);
                const cities = await response.json();
                
                if (cities.length === 0) {
                    selectElement.innerHTML = '<option value="">Aucune ville trouv√©e pour ce code postal</option>';
                    return;
                }
                
                selectElement.innerHTML = '<option value="">S√©lectionner une ville</option>';
                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city.nom;
                    option.textContent = city.nom;
                    selectElement.appendChild(option);
                });
                
                if (cities.length === 1) {
                    selectElement.value = cities[0].nom;
                }
            } catch (error) {
                selectElement.innerHTML = '<option value="">Erreur de chargement des villes</option>';
            }
        }

        function formatDateFR(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function printForm() {
            const form = document.getElementById('demande-form');
            
            // V√©rifier si le formulaire est rempli
            if (!form.checkValidity()) {
                showError('Veuillez remplir tous les champs obligatoires avant d\'imprimer.');
                form.reportValidity();
                return;
            }

            // R√©cup√©rer les donn√©es des bailleurs
            const bailleursData = [];
            const bailleurItems = document.querySelectorAll('.bailleur-item');
            bailleurItems.forEach(item => {
                const index = item.dataset.index;
                bailleursData.push({
                    nom: document.getElementById(`bailleur-nom-${index}`).value,
                    numero: document.getElementById(`bailleur-numero-${index}`).value,
                    voie: document.getElementById(`bailleur-voie-${index}`).value,
                    cp: document.getElementById(`bailleur-cp-${index}`).value,
                    ville: document.getElementById(`bailleur-ville-${index}`).value
                });
            });

            // R√©cup√©rer les donn√©es des locataires
            const locatairesData = [];
            const locataireItems = document.querySelectorAll('.locataire-item');
            locataireItems.forEach(item => {
                const index = item.dataset.index;
                locatairesData.push({
                    nom: document.getElementById(`locataire-nom-${index}`).value,
                    numero: document.getElementById(`locataire-numero-${index}`).value,
                    voie: document.getElementById(`locataire-voie-${index}`).value,
                    cp: document.getElementById(`locataire-cp-${index}`).value,
                    ville: document.getElementById(`locataire-ville-${index}`).value
                });
            });

            // Formater les bailleurs et locataires pour l'impression
            const bailleursFormatted = bailleursData.map((b, i) => 
                `Bailleur ${i + 1}:\n${b.nom}\n${b.numero} ${b.voie}\n${b.cp} ${b.ville}`
            ).join('\n\n');

            const locatairesFormatted = locatairesData.map((l, i) => 
                `Locataire ${i + 1}:\n${l.nom}\n${l.numero} ${l.voie}\n${l.cp} ${l.ville}`
            ).join('\n\n');

            // R√©cup√©rer les donn√©es du formulaire
            const formData = {
                nom_mandataire: document.getElementById('nom-mandataire').value,
                email_mandataire: document.getElementById('email-mandataire').value,
                date_signature: document.getElementById('date-signature').value,
                honoraires_bailleur_ttc: document.getElementById('honoraires-bailleur-ttc').value,
                honoraires_locataire_ttc: document.getElementById('honoraires-locataire-ttc').value,
                designation_bien: document.getElementById('designation-bien').value,
                numero_mandat: document.getElementById('numero-mandat').value,
                bailleurs: bailleursFormatted,
                locataires: locatairesFormatted
            };

            // Cr√©er une fen√™tre d'impression avec le contenu format√©
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="fr">
                <head>
                    <meta charset="UTF-8">
                    <title>Demande de facture - Location</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            padding: 20px;
                            color: #333;
                            line-height: 1.4;
                            font-size: 11px;
                            position: relative;
                        }
                        .logo-print {
                            position: absolute;
                            top: 20px;
                            left: 20px;
                            width: 266px;
                            height: 60px;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 15px;
                            margin-top: 160px;
                            border-bottom: 2px solid #2563eb;
                            padding-bottom: 10px;
                            padding-left: 120px;
                        }
                        h1 {
                            color: #1e293b;
                            font-size: 16px;
                            margin-bottom: 5px;
                        }
                        .company {
                            color: #2563eb;
                            font-size: 13px;
                            font-weight: bold;
                        }
                        .section {
                            margin-bottom: 12px;
                            page-break-inside: avoid;
                        }
                        .label {
                            font-weight: bold;
                            color: #1e293b;
                            margin-bottom: 3px;
                            font-size: 10px;
                        }
                        .value {
                            color: #475569;
                            padding: 6px;
                            background-color: #f8fafc;
                            border-left: 2px solid #2563eb;
                            margin-bottom: 8px;
                            font-size: 10px;
                            white-space: pre-line;
                        }
                        .footer {
                            margin-top: 20px;
                            padding-top: 10px;
                            border-top: 1px solid #e2e8f0;
                            text-align: center;
                            color: #64748b;
                            font-size: 9px;
                        }
                        .date-print {
                            text-align: right;
                            color: #64748b;
                            font-size: 9px;
                            margin-bottom: 10px;
                        }
                        @media print {
                            body {
                                padding: 15px;
                            }
                        }
                    </style>
                </head>
                <body>
                    <img src="logo-impression.png" alt="Logo MCI" class="logo-print" onerror="this.style.display='none'; this.alt='Logo non disponible';">
                    <div class="date-print">Imprim√© le ${new Date().toLocaleDateString('fr-FR', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })}</div>
                    
                    <div class="header">
                        <h1>Demande de facture de location</h1>
                        <div class="company">${config.company_name || defaultConfig.company_name}</div>
                    </div>

                    <div class="section">
                        <div class="label">1. Nom et pr√©nom du mandataire</div>
                        <div class="value">${formData.nom_mandataire}<br>${formData.email_mandataire}</div>
                    </div>

                    <div class="section">
                        <div class="label">2. Date de signature du bail</div>
                        <div class="value">${formatDateFR(formData.date_signature)}</div>
                    </div>

                    <div class="section">
                        <div class="label">3. Honoraires charge bailleur TTC</div>
                        <div class="value">${formData.honoraires_bailleur_ttc}</div>
                    </div>

                    <div class="section">
                        <div class="label">4. Honoraires charge locataire TTC</div>
                        <div class="value">${formData.honoraires_locataire_ttc}</div>
                    </div>

                    <div class="section">
                        <div class="label">5. D√©signation et adresse du bien</div>
                        <div class="value">${formData.designation_bien}</div>
                    </div>

                    <div class="section">
                        <div class="label">6. Num√©ro du mandat</div>
                        <div class="value">${formData.numero_mandat}</div>
                    </div>

                    <div class="section">
                        <div class="label">7. Nom et adresse des bailleurs</div>
                        <div class="value">${formData.bailleurs}</div>
                    </div>

                    <div class="section">
                        <div class="label">8. Nom et adresse des locataires</div>
                        <div class="value">${formData.locataires}</div>
                    </div>

                    <div class="footer">
                        <p>Document √† transmettre √† : ${config.email_label || defaultConfig.email_label}</p>
                        <p>Ce document doit √™tre remis lors de la signature du bail</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            
            // Attendre que le contenu soit charg√© puis lancer l'impression
            printWindow.onload = function() {
                printWindow.print();
            };
        }

        async function onConfigChange(newConfig) {
            document.body.style.background = `linear-gradient(to bottom right, ${newConfig.background_color || defaultConfig.background_color}, #dbeafe)`;
            
            const surfaces = document.querySelectorAll('.bg-white');
            surfaces.forEach(el => {
                el.style.backgroundColor = newConfig.surface_color || defaultConfig.surface_color;
            });

            document.getElementById('form-title').textContent = newConfig.form_title || defaultConfig.form_title;
            document.getElementById('company-name').textContent = newConfig.company_name || defaultConfig.company_name;
            document.getElementById('email-label').textContent = newConfig.email_label || defaultConfig.email_label;

            const customFont = newConfig.font_family || defaultConfig.font_family;
            const baseFontStack = 'Tahoma, Geneva, Verdana, sans-serif';
            document.body.style.fontFamily = `${customFont}, ${baseFontStack}`;

            const baseSize = newConfig.font_size || defaultConfig.font_size;
            document.getElementById('form-title').style.fontSize = `${baseSize * 1.875}px`;
            document.querySelectorAll('h2, h3').forEach(el => {
                el.style.fontSize = `${baseSize * 1.5}px`;
            });
            document.body.style.fontSize = `${baseSize}px`;
            document.querySelectorAll('.text-sm').forEach(el => {
                el.style.fontSize = `${baseSize * 0.875}px`;
            });

            const textElements = document.querySelectorAll('h1, h2, h3, label, p, span');
            textElements.forEach(el => {
                if (!el.classList.contains('text-blue-600') && !el.classList.contains('text-green-800') && 
                    !el.classList.contains('text-red-800') && !el.classList.contains('text-slate-500')) {
                    el.style.color = newConfig.text_color || defaultConfig.text_color;
                }
            });

            const printBtn = document.getElementById('print-btn');
            printBtn.style.backgroundColor = newConfig.primary_action_color || defaultConfig.primary_action_color;
            printBtn.onmouseover = () => {
                const color = newConfig.primary_action_color || defaultConfig.primary_action_color;
                printBtn.style.backgroundColor = adjustBrightness(color, -20);
            };
            printBtn.onmouseout = () => {
                printBtn.style.backgroundColor = newConfig.primary_action_color || defaultConfig.primary_action_color;
            };

            // Mettre √† jour les boutons d'ajout/suppression
            const addButtons = document.querySelectorAll('.bg-green-500');
            addButtons.forEach(btn => {
                btn.style.backgroundColor = '#22c55e';
            });

            const removeButtons = document.querySelectorAll('.bg-red-500');
            removeButtons.forEach(btn => {
                btn.style.backgroundColor = '#ef4444';
            });
        }

        function adjustBrightness(hex, percent) {
            const num = parseInt(hex.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255))
                .toString(16).slice(1);
        }

        if (window.elementSdk) {
            window.elementSdk.init({
                defaultConfig,
                onConfigChange,
                mapToCapabilities: (cfg) => ({
                    recolorables: [
                        {
                            get: () => cfg.background_color || defaultConfig.background_color,
                            set: (value) => {
                                cfg.background_color = value;
                                window.elementSdk.setConfig({ background_color: value });
                            }
                        },
                        {
                            get: () => cfg.surface_color || defaultConfig.surface_color,
                            set: (value) => {
                                cfg.surface_color = value;
                                window.elementSdk.setConfig({ surface_color: value });
                            }
                        },
                        {
                            get: () => cfg.text_color || defaultConfig.text_color,
                            set: (value) => {
                                cfg.text_color = value;
                                window.elementSdk.setConfig({ text_color: value });
                            }
                        },
                        {
                            get: () => cfg.primary_action_color || defaultConfig.primary_action_color,
                            set: (value) => {
                                cfg.primary_action_color = value;
                                window.elementSdk.setConfig({ primary_action_color: value });
                            }
                        },
                        {
                            get: () => cfg.secondary_action_color || defaultConfig.secondary_action_color,
                            set: (value) => {
                                cfg.secondary_action_color = value;
                                window.elementSdk.setConfig({ secondary_action_color: value });
                            }
                        }
                    ],
                    borderables: [],
                    fontEditable: {
                        get: () => cfg.font_family || defaultConfig.font_family,
                        set: (value) => {
                            cfg.font_family = value;
                            window.elementSdk.setConfig({ font_family: value });
                        }
                    },
                    fontSizeable: {
                        get: () => cfg.font_size || defaultConfig.font_size,
                        set: (value) => {
                            cfg.font_size = value;
                            window.elementSdk.setConfig({ font_size: value });
                        }
                    }
                }),
                mapToEditPanelValues: (cfg) => new Map([
                    ["form_title", cfg.form_title || defaultConfig.form_title],
                    ["company_name", cfg.company_name || defaultConfig.company_name],
                    ["email_label", cfg.email_label || defaultConfig.email_label]
                ])
            });

            config = window.elementSdk.config;
        }

        if (window.dataSdk) {
            window.dataSdk.init(dataHandler);
        }

        // Initialiser les formulaires au chargement de la page
        window.addEventListener('load', function() {
            initialiserFormulaires();
            document.getElementById('demande-form').reset();
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a92b958f15a018c',t:'MTc2NDkyOTExNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>